<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Material | Intellaica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-white px-6 py-4 shadow flex justify-between items-center mb-8">
    <div class="font-bold text-xl text-blue-700">
      Intellaica
      <span class="hidden sm:inline text-gray-400 text-lg mx-2">|</span>
      <span class="hidden md:inline text-gray-700 font-semibold">Teacher Portal</span>
    </div>
    <a href="/auth/logout"
       class="py-2 px-5 text-sm font-medium bg-red-50 text-red-600 rounded-lg border border-red-100 hover:bg-red-100 flex items-center">
      🚪 Logout
    </a>
  </nav>

  <main class="max-w-3xl mx-auto px-4">
    <div class="grid md:grid-cols-2 gap-8">
      <!-- Upload Material Card -->
      <div class="bg-white rounded-xl shadow p-7 border border-gray-100 flex flex-col justify-center">
        <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">📤 Upload Course Material</h2>
        <form class="space-y-4"
              hx-post="/ai/courses/{{ course_id }}/upload_materials"
              method="post"
              enctype="multipart/form-data"
              hx-target="#success-toast"
              hx-swap="innerHTML">
          <input type="file" name="file" required
            class="block w-full text-sm text-gray-700 file:bg-blue-50 file:border-none file:rounded-lg file:px-4 file:py-2 file:text-blue-700 file:font-semibold file:mr-4"/>
          <button type="submit"
            class="w-full py-2 mt-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center">
            Upload
          </button>
        </form>
        <div id="success-toast" class="mt-3"></div>
      </div>

      <!-- Uploaded Materials Table -->
      <div class="bg-white rounded-xl shadow p-7 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-5">📚 Uploaded Materials</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full mb-2 text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="font-semibold px-4 py-2">File</th>
                <th class="font-semibold px-4 py-2">Date</th>
              </tr>
            </thead>
            <tbody>
              {% for material in materials %}
              <tr class="border-b">
                <td class="px-4 py-2">
                  <a href="/{{ material.filepath }}" target="_blank" download
                    class="text-blue-700 underline font-medium hover:text-blue-900">
                    📄 {{ material.title or material.filename }}
                  </a>
                </td>
                <td class="px-4 py-2">{{ material.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="2" class="text-center text-gray-400 py-4">No materials uploaded yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- Process Materials Button -->
        <div class="text-center mt-6">
          <button
            hx-post="/ai/courses/{{ course_id }}/process_materials"
            hx-target="#process-status"
            hx-indicator="#loader"
            class="inline-flex items-center gap-2 px-5 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
            hx-swap="outerHTML">
            ⚙️ Process Materials
          </button>
          <div id="loader" class="animate-spin mx-auto mt-2 w-6 h-6 border-4 border-blue-200 border-t-blue-600 rounded-full hidden"></div>
        </div>
        <!-- Display status of the processing -->
        <div id="process-status" class="mt-4"></div>
      </div>
    </div>

    <div class="text-center mt-12">
      {% if role == "teacher" %}
        <a href="/auth/teacher/dashboard" class="text-blue-700 hover:underline inline-flex items-center gap-1">
          ⬅ Back to Dashboard
        </a>
      {% else %}
        <a href="/auth/student/courses" class="text-blue-700 hover:underline inline-flex items-center gap-1">
          ⬅ Back to Dashboard
        </a>
      {% endif %}
    </div>
  </main>
  <script>
    // HTMX loader indicator for process materials
    document.body.addEventListener('htmx:configRequest', function(evt) {
      if(evt.target.closest('[hx-indicator="#loader"]')) {
        document.getElementById('loader').classList.remove('hidden');
      }
    });
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if(evt.target.id === "process-status") {
        document.getElementById('loader').classList.add('hidden');
      }
    });
  </script>
</body>
</html>