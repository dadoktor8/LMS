<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Monitor | {{ activity.activity_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-blue-700 mb-2">Monitor Activity: {{ activity.activity_name }}</h1>
      <p class="text-lg text-gray-600">
        {{ activity.activity_type|title }} ‚Ä¢ {{ activity.participation_type|title }} ‚Ä¢ {{ activity.complexity|title }}
        {% if activity.module %}‚Ä¢ Module: {{ activity.module.title }}{% endif %}
      </p>
      <p class="text-xs text-gray-400 mt-1">
        Created {{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else '' }}
        {% if activity.started_at %}| Started {{ activity.started_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
        {% if activity.ended_at %}| Ended {{ activity.ended_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
      </p>
      <div class="mt-4 flex gap-3">
        {% if activity.is_active %}
          <form hx-post="/ai/teacher/activities/{{ activity.id }}/end" hx-swap="outerHTML">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">End Activity</button>
          </form>
        {% else %}
          <form hx-post="/ai/teacher/activities/{{ activity.id }}/start" hx-swap="outerHTML">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Start Activity</button>
          </form>
        {% endif %}
        <a href="/ai/teacher/courses/{{ activity.course_id }}/inclass-activities"
           class="text-blue-600 hover:underline px-3 py-2 rounded">‚Üê Back to Activities</a>
      </div>
    </div>

    <!-- Participation List -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Student Participation</h2>

      {% if activity.participation_type == "group" %}
        <!-- Grouped table -->
        {% if groups %}
          {% for group in groups %}
            <div class="mb-6">
              <h3 class="font-bold text-blue-600 text-lg mb-2">Group: {{ group.group_name }}</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full table-auto text-left bg-blue-50 rounded">
                  <thead>
                    <tr>
                      <th class="px-4 py-2">Student</th>
                      <th class="px-4 py-2">Status</th>
                      <th class="px-4 py-2">Submitted At</th>
                      <th class="px-4 py-2">AI Feedback</th>
                      <th class="px-4 py-2">Peer Feedback</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in participations if p.group_id == group.id %}
                      <tr class="border-b last:border-b-0">
                        <td class="px-4 py-2">{{ p.student.f_name if p.student else 'Unknown' }}</td>
                        <td class="px-4 py-2">
                          {% if p.status == "submitted" %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                          {% else %}
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Not Submitted</span>
                          {% endif %}
                        </td>
                        <td class="px-4 py-2">
                          {{ p.submitted_at.strftime('%Y-%m-%d %H:%M') if p.submitted_at else '--' }}
                        </td>
                        <td class="px-4 py-2">
                          {% if p.ai_feedback %}
                            <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/ai-feedback"
                                    hx-target="#ai-feedback-modal"
                                    hx-trigger="click"
                                    class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                              View
                            </button>
                          {% else %}
                            <span class="text-gray-400 text-xs">Not Available</span>
                          {% endif %}
                        </td>
                        <td class="px-4 py-2">
                          {% if p.peer_feedback %}
                            <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/peer-feedback"
                                    hx-target="#ai-feedback-modal"
                                    hx-trigger="click"
                                    class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs hover:bg-purple-200">
                              View
                            </button>
                          {% else %}
                            <span class="text-gray-400 text-xs">Not Available</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-gray-500 py-6 text-center">No groups or participations yet.</p>
        {% endif %}
      {% else %}
        <!-- Flat (individual) table -->
        {% if participations %}
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto text-left bg-blue-50 rounded">
              <thead>
                <tr>
                  <th class="px-4 py-2">Student</th>
                  <th class="px-4 py-2">Status</th>
                  <th class="px-4 py-2">Submitted At</th>
                  <th class="px-4 py-2">AI Feedback</th>
                  <th class="px-4 py-2">Peer Feedback</th>
                </tr>
              </thead>
              <tbody>
                {% for p in participations %}
                  <tr class="border-b last:border-b-0">
                    <td class="px-4 py-2">{{ p.student.f_name if p.student else 'Unknown' }}</td>
                    <td class="px-4 py-2">
                      {% if p.status == "submitted" %}
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                      {% else %}
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Not Submitted</span>
                      {% endif %}
                    </td>
                    <td class="px-4 py-2">
                      {{ p.submitted_at.strftime('%Y-%m-%d %H:%M') if p.submitted_at else '--' }}
                    </td>
                    <td class="px-4 py-2">
                      {% if p.ai_feedback %}
                        <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/ai-feedback"
                                hx-target="#ai-feedback-modal"
                                hx-trigger="click"
                                class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                          View
                        </button>
                      {% else %}
                        <span class="text-gray-400 text-xs">Not Available</span>
                      {% endif %}
                    </td>
                    <td class="px-4 py-2">
                      {% if p.peer_feedback %}
                        <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/peer-feedback"
                                hx-target="#ai-feedback-modal"
                                hx-trigger="click"
                                class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs hover:bg-purple-200">
                          View
                        </button>
                      {% else %}
                        <span class="text-gray-400 text-xs">Not Available</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500 py-6 text-center">No participations yet.</p>
        {% endif %}
      {% endif %}
    </div>

    <!-- Activity-Specific Monitoring Sections -->
    {% if activity.activity_type == 'peer_quiz' %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">üß© Peer Quiz Monitoring</h2>
        <div class="flex gap-2">
          <a href="/ai/teacher/activities/{{ activity.id }}/quiz-overview" 
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
            üìä Quiz Overview
          </a>
          <a href="/ai/teacher/activities/{{ activity.id }}/peer-analytics" 
             class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
            üìà Analytics
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-600">
            {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
          </div>
          <div class="text-sm text-blue-800">Quizzes Submitted</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-600" id="quiz-attempts-count">-</div>
          <div class="text-sm text-green-800">Total Quiz Attempts</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-600" id="comments-count">-</div>
          <div class="text-sm text-purple-800">Peer Comments</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-orange-600" id="avg-score">-</div>
          <div class="text-sm text-orange-800">Average Score</div>
        </div>
      </div>

      <!-- Recent Quiz Activity -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="font-semibold mb-3">üìù Recent Quiz Activity</h3>
        <div id="recent-activity" class="space-y-2">
          <p class="text-gray-500 text-sm">Loading recent activity...</p>
        </div>
        <div class="mt-4 text-center">
          <button hx-get="/ai/teacher/activities/{{ activity.id }}/quiz-activity" 
                  hx-target="#recent-activity"
                  hx-trigger="click"
                  class="text-blue-600 hover:underline text-sm">
            Load Recent Activity
          </button>
        </div>
      </div>
    </div>

    {% elif activity.activity_type == 'concept_mapping' %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">üó∫Ô∏è Concept Mapping Monitoring</h2>
        <div class="flex gap-2">
          <a href="/ai/teacher/activities/{{ activity.id }}/concept-map-overview" 
             class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
            üìä Map Overview
          </a>
          <a href="/ai/teacher/activities/{{ activity.id }}/concept-analytics" 
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
            üìà Analytics
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-purple-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-600">
            {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
          </div>
          <div class="text-sm text-purple-800">Maps Submitted</div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-600" id="avg-concepts-count">
            {% set submitted_maps = participations|selectattr('status', 'equalto', 'submitted')|list %}
            {% if submitted_maps %}
              {% set total_concepts = 0 %}
              {% for p in submitted_maps %}
                {% if p.submission_data and p.submission_data.concepts %}
                  {% set total_concepts = total_concepts + p.submission_data.concepts|length %}
                {% endif %}
              {% endfor %}
              {{ "%.1f"|format(total_concepts / submitted_maps|length) if submitted_maps|length > 0 else 0 }}
            {% else %}
              0
            {% endif %}
          </div>
          <div class="text-sm text-blue-800">Avg Concepts</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-600" id="completion-rate">
            {% set total_participants = participations|length %}
            {% if total_participants > 0 %}
              {{ "%.0f"|format((submitted_maps|length / total_participants) * 100) }}%
            {% else %}
              0%
            {% endif %}
          </div>
          <div class="text-sm text-green-800">Completion Rate</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-orange-600" id="complexity-score">
            {% if submitted_maps %}
              {% set avg_concepts = total_concepts / submitted_maps|length if submitted_maps|length > 0 else 0 %}
              {% if avg_concepts >= 12 %}High{% elif avg_concepts >= 8 %}Medium{% else %}Basic{% endif %}
            {% else %}
              -
            {% endif %}
          </div>
          <div class="text-sm text-orange-800">Avg Complexity</div>
        </div>
      </div>

      <!-- Recent Submissions -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="font-semibold mb-3">üìù Recent Concept Map Activity</h3>
        <div id="recent-concept-activity" class="space-y-2">
          {% if submitted_maps %}
          {% for participation in submitted_maps|reverse %}
          <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-purple-400">
            <div class="flex items-start space-x-3">
              <span class="text-purple-600">üó∫Ô∏è</span>
              <div>
                <p class="text-sm">
                  <span class="font-medium">{{ participation.student.f_name }}</span>
                  {% if participation.group %}
                  <span class="text-gray-500">({{ participation.group.group_name }})</span>
                  {% endif %}
                  submitted their concept map
                </p>
                <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                  <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                  {% if participation.submission_data %}
                  <span>{{ participation.submission_data.concepts|length }} concepts</span>
                  <span>{{ participation.submission_data.connections|length }} chars</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="flex-shrink-0">
              <a href="/ai/teacher/activities/{{ activity.id }}/concept-map/{{ participation.id }}/view" 
                 class="text-purple-600 hover:text-purple-800 text-xs">
                View ‚Üí
              </a>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-gray-500 text-sm">No concept maps submitted yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {% elif activity.activity_type == 'knowledge_mapping' %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">üß† Knowledge Mapping Monitoring</h2>
        <div class="flex gap-2">
          <a href="/ai/teacher/activities/{{ activity.id }}/knowledge-map-overview" 
             class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
            üìä Map Overview
          </a>
          <a href="/ai/teacher/activities/{{ activity.id }}/knowledge-analytics" 
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
            üìà Analytics
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-purple-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-600">
            {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
          </div>
          <div class="text-sm text-purple-800">Maps Submitted</div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-600" id="avg-topics-count">
            {% set submitted_maps = participations|selectattr('status', 'equalto', 'submitted')|list %}
            {% if submitted_maps %}
              {% set total_topics = 0 %}
              {% for p in submitted_maps %}
                {% if p.submission_data and p.submission_data.key_topics %}
                  {% set total_topics = total_topics + p.submission_data.key_topics|length %}
                {% endif %}
              {% endfor %}
              {{ "%.1f"|format(total_topics / submitted_maps|length) if submitted_maps|length > 0 else 0 }}
            {% else %}
              0
            {% endif %}
          </div>
          <div class="text-sm text-blue-800">Avg Topics</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-600" id="completion-rate">
            {% set total_participants = participations|length %}
            {% if total_participants > 0 %}
              {{ "%.0f"|format((submitted_maps|length / total_participants) * 100) }}%
            {% else %}
              0%
            {% endif %}
          </div>
          <div class="text-sm text-green-800">Completion Rate</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-orange-600" id="self-awareness-score">
            {% if submitted_maps %}
              {% set gap_responses = 0 %}
              {% for p in submitted_maps %}
                {% if p.submission_data and p.submission_data.knowledge_gaps and p.submission_data.knowledge_gaps|length > 50 %}
                  {% set gap_responses = gap_responses + 1 %}
                {% endif %}
              {% endfor %}
              {{ "%.0f"|format((gap_responses / submitted_maps|length) * 100) if submitted_maps|length > 0 else 0 }}%
            {% else %}
              0%
            {% endif %}
          </div>
          <div class="text-sm text-orange-800">Self-Awareness</div>
        </div>
      </div>

      <!-- Recent Submissions -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="font-semibold mb-3">üìù Recent Knowledge Map Activity</h3>
        <div id="recent-knowledge-activity" class="space-y-2">
          {% if submitted_maps %}
          {% for participation in submitted_maps|reverse %}
          <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-purple-400">
            <div class="flex items-start space-x-3">
              <span class="text-purple-600">üß†</span>
              <div>
                <p class="text-sm">
                  <span class="font-medium">{{ participation.student.f_name }}</span>
                  {% if participation.group %}
                  <span class="text-gray-500">({{ participation.group.group_name }})</span>
                  {% endif %}
                  submitted their knowledge map
                </p>
                <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                  <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                  {% if participation.submission_data %}
                  <span>{{ participation.submission_data.key_topics|length }} topics</span>
                  <span>{{ participation.submission_data.connections|length }} chars connections</span>
                  <span>{{ participation.submission_data.knowledge_gaps|length }} chars gaps</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="flex-shrink-0">
              <a href="/ai/teacher/activities/{{ activity.id }}/knowledge-map/{{ participation.id }}/view" 
                 class="text-purple-600 hover:text-purple-800 text-xs">
                View ‚Üí
              </a>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-gray-500 text-sm">No knowledge maps submitted yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
<!-- Add this section to activity_monitor.html after knowledge_mapping -->

      {% elif activity.activity_type == 'think_pair_create' %}
      <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">ü§ù Think-Pair-Create Monitoring</h2>
          <div class="flex gap-2">
            <a href="/ai/teacher/activities/{{ activity.id }}/think-pair-create-overview" 
              class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
              üìä TPC Overview
            </a>
            <a href="/ai/teacher/activities/{{ activity.id }}/collaboration-analytics" 
              class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
              üìà Analytics
            </a>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid md:grid-cols-4 gap-4 mb-6">
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-600">
              {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
            </div>
            <div class="text-sm text-purple-800">TPC Submitted</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="avg-word-count">
              {% set submitted_tpc = participations|selectattr('status', 'equalto', 'submitted')|list %}
              {% if submitted_tpc %}
                {% set total_words = 0 %}
                {% for p in submitted_tpc %}
                  {% if p.submission_data and p.submission_data.create_paragraph %}
                    {% set total_words = total_words + p.submission_data.create_paragraph.split()|length %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format(total_words / submitted_tpc|length) if submitted_tpc|length > 0 else 0 }}
              {% else %}
                0
              {% endif %}
            </div>
            <div class="text-sm text-blue-800">Avg Words</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="completion-rate">
              {% set total_participants = participations|length %}
              {% if total_participants > 0 %}
                {{ "%.0f"|format((submitted_tpc|length / total_participants) * 100) }}%
              {% else %}
                0%
              {% endif %}
            </div>
            <div class="text-sm text-green-800">Completion Rate</div>
          </div>
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-orange-600" id="collaboration-score">
              {% if submitted_tpc %}
                {% set discussion_responses = 0 %}
                {% for p in submitted_tpc %}
                  {% if p.submission_data and p.submission_data.pair_discussion and p.submission_data.pair_discussion|length > 100 %}
                    {% set discussion_responses = discussion_responses + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((discussion_responses / submitted_tpc|length) * 100) if submitted_tpc|length > 0 else 0 }}%
              {% else %}
                0%
              {% endif %}
            </div>
            <div class="text-sm text-orange-800">Collaboration Quality</div>
          </div>
        </div>

        <!-- Recent Submissions -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-semibold mb-3">üìù Recent Think-Pair-Create Activity</h3>
          <div id="recent-tpc-activity" class="space-y-2">
            {% if submitted_tpc %}
            {% for participation in submitted_tpc|reverse %}
            <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-purple-400">
              <div class="flex items-start space-x-3">
                <span class="text-purple-600">ü§ù</span>
                <div>
                  <p class="text-sm">
                    <span class="font-medium">{{ participation.student.f_name }}</span>
                    {% if participation.group %}
                    <span class="text-gray-500">({{ participation.group.group_name }})</span>
                    {% endif %}
                    completed Think-Pair-Create
                  </p>
                  <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                    <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                    {% if participation.submission_data %}
                    <span>{{ participation.submission_data.think_response.split()|length }} think words</span>
                    <span>{{ participation.submission_data.pair_discussion.split()|length }} discussion words</span>
                    <span>{{ participation.submission_data.create_paragraph.split()|length }} final words</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="flex-shrink-0">
                <a href="/ai/teacher/activities/{{ activity.id }}/think-pair-create/{{ participation.id }}/view" 
                  class="text-purple-600 hover:text-purple-800 text-xs">
                  View ‚Üí
                </a>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-500 text-sm">No Think-Pair-Create submissions yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Add this section to activity_monitor.html after think_pair_create -->

      {% elif activity.activity_type == 'mystery_box_challenge' %}
      <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">üì¶ Mystery Box Challenge Monitoring</h2>
          <div class="flex gap-2">
            <a href="/ai/teacher/activities/{{ activity.id }}/mystery-box-overview" 
              class="bg-orange-600 text-white px-4 py-2 rounded text-sm hover:bg-orange-700">
              üìä Challenge Overview
            </a>
            <a href="/ai/teacher/activities/{{ activity.id }}/creativity-analytics" 
              class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
              üìà Creativity Analytics
            </a>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid md:grid-cols-4 gap-4 mb-6">
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-orange-600">
              {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
            </div>
            <div class="text-sm text-orange-800">Challenges Submitted</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="avg-creativity-score">
              {% set submitted_challenges = participations|selectattr('status', 'equalto', 'submitted')|list %}
              {% if submitted_challenges %}
                {% set total_sections = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data %}
                    {% set sections_completed = 0 %}
                    {% if p.submission_data.concept_identification %}{% set sections_completed = sections_completed + 1 %}{% endif %}
                    {% if p.submission_data.creative_connections %}{% set sections_completed = sections_completed + 1 %}{% endif %}
                    {% if p.submission_data.story_design %}{% set sections_completed = sections_completed + 1 %}{% endif %}
                    {% if p.submission_data.integration_plan %}{% set sections_completed = sections_completed + 1 %}{% endif %}
                    {% set total_sections = total_sections + sections_completed %}
                  {% endif %}
                {% endfor %}
                {{ "%.1f"|format((total_sections / (submitted_challenges|length * 4)) * 100) if submitted_challenges|length > 0 else 0 }}%
              {% else %}
                0%
              {% endif %}
            </div>
            <div class="text-sm text-blue-800">Completeness</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="completion-rate">
              {% set total_participants = participations|length %}
              {% if total_participants > 0 %}
                {{ "%.0f"|format((submitted_challenges|length / total_participants) * 100) }}%
              {% else %}
                0%
              {% endif %}
            </div>
            <div class="text-sm text-green-800">Submission Rate</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-600" id="innovation-score">
              {% if submitted_challenges %}
                {% set innovative_solutions = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data and p.submission_data.story_design and p.submission_data.story_design|length > 200 %}
                    {% set innovative_solutions = innovative_solutions + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((innovative_solutions / submitted_challenges|length) * 100) if submitted_challenges|length > 0 else 0 }}%
              {% else %}
                0%
              {% endif %}
            </div>
            <div class="text-sm text-purple-800">Innovation Rate</div>
          </div>
        </div>

        <!-- Recent Submissions -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-semibold mb-3">üìù Recent Mystery Box Activity</h3>
          <div id="recent-mystery-box-activity" class="space-y-2">
            {% if submitted_challenges %}
            {% for participation in submitted_challenges|reverse %}
            <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-orange-400">
              <div class="flex items-start space-x-3">
                <span class="text-orange-600">üì¶</span>
                <div>
                  <p class="text-sm">
                    <span class="font-medium">{{ participation.student.f_name }}</span>
                    {% if participation.group %}
                    <span class="text-gray-500">({{ participation.group.group_name }})</span>
                    {% endif %}
                    completed Mystery Box Challenge
                  </p>
                  <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                    <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                    {% if participation.submission_data %}
                    <span>{{ participation.submission_data.concept_identification.split()|length if participation.submission_data.concept_identification else 0 }} identify words</span>
                    <span>{{ participation.submission_data.creative_connections.split()|length if participation.submission_data.creative_connections else 0 }} connection words</span>
                    <span>{{ participation.submission_data.story_design.split()|length if participation.submission_data.story_design else 0 }} design words</span>
                    {% endif %}
                  </div>
                  {% if participation.submission_data and participation.submission_data.story_design %}
                  <div class="mt-1 text-xs text-gray-600 italic">
                    "{{ participation.submission_data.story_design[:60] }}..."
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="flex-shrink-0">
                <a href="/ai/teacher/activities/{{ activity.id }}/mystery-box/{{ participation.id }}/view" 
                  class="text-orange-600 hover:text-orange-800 text-xs">
                  View ‚Üí
                </a>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-500 text-sm">No Mystery Box Challenge submissions yet.</p>
            {% endif %}
          </div>
        </div>

        <!-- Challenge Phase Progress -->
        <div class="mt-6 bg-gray-50 rounded-lg p-4">
          <h3 class="font-semibold mb-3">üéØ Challenge Phase Completion</h3>
          {% if submitted_challenges %}
          <div class="grid grid-cols-4 gap-4">
            <!-- Identify Phase -->
            <div class="bg-blue-50 rounded p-3 text-center">
              <div class="text-blue-600 text-xl mb-1">üîç</div>
              <div class="text-blue-800 font-medium text-sm">IDENTIFY</div>
              <div class="text-blue-700 text-xs">
                {% set identify_completed = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data and p.submission_data.concept_identification and p.submission_data.concept_identification|length > 50 %}
                    {% set identify_completed = identify_completed + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((identify_completed / submitted_challenges|length) * 100) if submitted_challenges|length > 0 else 0 }}% Quality
              </div>
            </div>
            
            <!-- Connect Phase -->
            <div class="bg-purple-50 rounded p-3 text-center">
              <div class="text-purple-600 text-xl mb-1">üîó</div>
              <div class="text-purple-800 font-medium text-sm">CONNECT</div>
              <div class="text-purple-700 text-xs">
                {% set connect_completed = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data and p.submission_data.creative_connections and p.submission_data.creative_connections|length > 100 %}
                    {% set connect_completed = connect_completed + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((connect_completed / submitted_challenges|length) * 100) if submitted_challenges|length > 0 else 0 }}% Quality
              </div>
            </div>
            
            <!-- Design Phase -->
            <div class="bg-green-50 rounded p-3 text-center">
              <div class="text-green-600 text-xl mb-1">üé®</div>
              <div class="text-green-800 font-medium text-sm">DESIGN</div>
              <div class="text-green-700 text-xs">
                {% set design_completed = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data and p.submission_data.story_design and p.submission_data.story_design|length > 150 %}
                    {% set design_completed = design_completed + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((design_completed / submitted_challenges|length) * 100) if submitted_challenges|length > 0 else 0 }}% Quality
              </div>
            </div>
            
            <!-- Implement Phase -->
            <div class="bg-orange-50 rounded p-3 text-center">
              <div class="text-orange-600 text-xl mb-1">üöÄ</div>
              <div class="text-orange-800 font-medium text-sm">IMPLEMENT</div>
              <div class="text-orange-700 text-xs">
                {% set implement_completed = 0 %}
                {% for p in submitted_challenges %}
                  {% if p.submission_data and p.submission_data.integration_plan and p.submission_data.integration_plan|length > 100 %}
                    {% set implement_completed = implement_completed + 1 %}
                  {% endif %}
                {% endfor %}
                {{ "%.0f"|format((implement_completed / submitted_challenges|length) * 100) if submitted_challenges|length > 0 else 0 }}% Quality
              </div>
            </div>
          </div>
          {% else %}
          <p class="text-gray-500 text-center">No submissions to analyze yet.</p>
          {% endif %}
        </div>
      </div>
      <!-- Add this section to activity_monitor.html after mystery_box_challenge -->

        {% elif activity.activity_type == 'global_adaptation_challenge' %}
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">üåç Global Adaptation Challenge Monitoring</h2>
            <div class="flex gap-2">
              <a href="/ai/teacher/activities/{{ activity.id }}/global-adaptation-overview" 
                class="bg-teal-600 text-white px-4 py-2 rounded text-sm hover:bg-teal-700">
                üìä Adaptation Overview
              </a>
              <a href="/ai/teacher/activities/{{ activity.id }}/localization-analytics" 
                class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                üìà Localization Analytics
              </a>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div class="bg-teal-50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-teal-600">
                {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
              </div>
              <div class="text-sm text-teal-800">Adaptations Submitted</div>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-blue-600" id="avg-cultural-depth">
                {% set submitted_adaptations = participations|selectattr('status', 'equalto', 'submitted')|list %}
                {% if submitted_adaptations %}
                  {% set total_cultural_research = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.cultural_research %}
                      {% set total_cultural_research = total_cultural_research + p.submission_data.cultural_research.split()|length %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format(total_cultural_research / submitted_adaptations|length) if submitted_adaptations|length > 0 else 0 }}
                {% else %}
                  0
                {% endif %}
              </div>
              <div class="text-sm text-blue-800">Avg Cultural Words</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-green-600" id="completion-rate">
                {% set total_participants = participations|length %}
                {% if total_participants > 0 %}
                  {{ "%.0f"|format((submitted_adaptations|length / total_participants) * 100) }}%
                {% else %}
                  0%
                {% endif %}
              </div>
              <div class="text-sm text-green-800">Submission Rate</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-purple-600" id="localization-score">
                {% if submitted_adaptations %}
                  {% set comprehensive_adaptations = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.localization_plan and p.submission_data.localization_plan|length > 200 %}
                      {% set comprehensive_adaptations = comprehensive_adaptations + 1 %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format((comprehensive_adaptations / submitted_adaptations|length) * 100) if submitted_adaptations|length > 0 else 0 }}%
                {% else %}
                  0%
                {% endif %}
              </div>
              <div class="text-sm text-purple-800">Comprehensive Rate</div>
            </div>
          </div>

          <!-- Recent Submissions -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="font-semibold mb-3">üìù Recent Global Adaptation Activity</h3>
            <div id="recent-global-adaptation-activity" class="space-y-2">
              {% if submitted_adaptations %}
              {% for participation in submitted_adaptations|reverse %}
              <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-teal-400">
                <div class="flex items-start space-x-3">
                  <span class="text-teal-600">üåç</span>
                  <div>
                    <p class="text-sm">
                      <span class="font-medium">{{ participation.student.f_name }}</span>
                      {% if participation.group %}
                      <span class="text-gray-500">({{ participation.group.group_name }})</span>
                      {% endif %}
                      completed Global Adaptation Challenge
                    </p>
                    <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                      <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                      {% if participation.submission_data %}
                      <span>{{ participation.submission_data.region_analysis.split()|length if participation.submission_data.region_analysis else 0 }} region words</span>
                      <span>{{ participation.submission_data.cultural_research.split()|length if participation.submission_data.cultural_research else 0 }} culture words</span>
                      <span>{{ participation.submission_data.adaptation_strategy.split()|length if participation.submission_data.adaptation_strategy else 0 }} strategy words</span>
                      {% endif %}
                    </div>
                    {% if participation.submission_data and participation.submission_data.adaptation_strategy %}
                    <div class="mt-1 text-xs text-gray-600 italic">
                      "{{ participation.submission_data.adaptation_strategy[:60] }}..."
                    </div>
                    {% endif %}
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <a href="/ai/teacher/activities/{{ activity.id }}/global-adaptation/{{ participation.id }}/view" 
                    class="text-teal-600 hover:text-teal-800 text-xs">
                    View ‚Üí
                  </a>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <p class="text-gray-500 text-sm">No Global Adaptation Challenge submissions yet.</p>
              {% endif %}
            </div>
          </div>

          <!-- Adaptation Phase Progress -->
          <div class="mt-6 bg-gray-50 rounded-lg p-4">
            <h3 class="font-semibold mb-3">üéØ Adaptation Phase Completion</h3>
            {% if submitted_adaptations %}
            <div class="grid grid-cols-4 gap-4">
              <!-- Analyze Phase -->
              <div class="bg-blue-50 rounded p-3 text-center">
                <div class="text-blue-600 text-xl mb-1">üåè</div>
                <div class="text-blue-800 font-medium text-sm">ANALYZE</div>
                <div class="text-blue-700 text-xs">
                  {% set analyze_completed = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.region_analysis and p.submission_data.region_analysis|length > 100 %}
                      {% set analyze_completed = analyze_completed + 1 %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format((analyze_completed / submitted_adaptations|length) * 100) if submitted_adaptations|length > 0 else 0 }}% Quality
                </div>
              </div>
              
              <!-- Research Phase -->
              <div class="bg-purple-50 rounded p-3 text-center">
                <div class="text-purple-600 text-xl mb-1">üèõÔ∏è</div>
                <div class="text-purple-800 font-medium text-sm">RESEARCH</div>
                <div class="text-purple-700 text-xs">
                  {% set research_completed = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.cultural_research and p.submission_data.cultural_research|length > 150 %}
                      {% set research_completed = research_completed + 1 %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format((research_completed / submitted_adaptations|length) * 100) if submitted_adaptations|length > 0 else 0 }}% Quality
                </div>
              </div>
              
              <!-- Strategy Phase -->
              <div class="bg-green-50 rounded p-3 text-center">
                <div class="text-green-600 text-xl mb-1">üéØ</div>
                <div class="text-green-800 font-medium text-sm">STRATEGIZE</div>
                <div class="text-green-700 text-xs">
                  {% set strategy_completed = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.adaptation_strategy and p.submission_data.adaptation_strategy|length > 200 %}
                      {% set strategy_completed = strategy_completed + 1 %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format((strategy_completed / submitted_adaptations|length) * 100) if submitted_adaptations|length > 0 else 0 }}% Quality
                </div>
              </div>
              
              <!-- Localize Phase -->
              <div class="bg-teal-50 rounded p-3 text-center">
                <div class="text-teal-600 text-xl mb-1">üöÄ</div>
                <div class="text-teal-800 font-medium text-sm">LOCALIZE</div>
                <div class="text-teal-700 text-xs">
                  {% set localize_completed = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.localization_plan and p.submission_data.localization_plan|length > 150 %}
                      {% set localize_completed = localize_completed + 1 %}
                    {% endif %}
                  {% endfor %}
                  {{ "%.0f"|format((localize_completed / submitted_adaptations|length) * 100) if submitted_adaptations|length > 0 else 0 }}% Quality
                </div>
              </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center">No submissions to analyze yet.</p>
            {% endif %}
          </div>

          <!-- Cultural Sensitivity Insights -->
          <div class="mt-6 bg-white rounded-lg shadow-md p-4">
            <h3 class="font-semibold mb-3">üèõÔ∏è Cultural Adaptation Insights</h3>
            {% if submitted_adaptations %}
            <div class="grid md:grid-cols-2 gap-4">
              <div class="bg-purple-50 rounded p-3">
                <h4 class="font-medium text-purple-800 mb-2">Cultural Research Depth</h4>
                <div class="space-y-1 text-sm">
                  {% set deep_research = 0 %}
                  {% set moderate_research = 0 %}
                  {% set basic_research = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.cultural_research %}
                      {% set words = p.submission_data.cultural_research.split()|length %}
                      {% if words > 200 %}
                        {% set deep_research = deep_research + 1 %}
                      {% elif words > 100 %}
                        {% set moderate_research = moderate_research + 1 %}
                      {% else %}
                        {% set basic_research = basic_research + 1 %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  <div class="flex justify-between">
                    <span>Deep Research:</span>
                    <span class="font-medium">{{ deep_research }} teams</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Moderate Research:</span>
                    <span class="font-medium">{{ moderate_research }} teams</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Basic Research:</span>
                    <span class="font-medium">{{ basic_research }} teams</span>
                  </div>
                </div>
              </div>
              
              <div class="bg-teal-50 rounded p-3">
                <h4 class="font-medium text-teal-800 mb-2">Localization Comprehensiveness</h4>
                <div class="space-y-1 text-sm">
                  {% set comprehensive_plans = 0 %}
                  {% set detailed_plans = 0 %}
                  {% set basic_plans = 0 %}
                  {% for p in submitted_adaptations %}
                    {% if p.submission_data and p.submission_data.localization_plan %}
                      {% set words = p.submission_data.localization_plan.split()|length %}
                      {% if words > 250 %}
                        {% set comprehensive_plans = comprehensive_plans + 1 %}
                      {% elif words > 150 %}
                        {% set detailed_plans = detailed_plans + 1 %}
                      {% else %}
                        {% set basic_plans = basic_plans + 1 %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  <div class="flex justify-between">
                    <span>Comprehensive Plans:</span>
                    <span class="font-medium">{{ comprehensive_plans }} teams</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Detailed Plans:</span>
                    <span class="font-medium">{{ detailed_plans }} teams</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Basic Plans:</span>
                    <span class="font-medium">{{ basic_plans }} teams</span>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center">No cultural adaptation data available yet.</p>
            {% endif %}
          </div>
        </div>
    {% endif %}
  </div>

  <!-- Modal Target for Feedback -->
  <div id="ai-feedback-modal"></div>
  <script>
  // Optional: Dismiss modal on click outside or ESC
  document.addEventListener('click', function(e) {
    const modal = document.getElementById('ai-feedback-modal');
    if (modal && modal.innerHTML.trim() !== '' && !modal.contains(e.target)) {
      modal.innerHTML = '';
    }
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      document.getElementById('ai-feedback-modal').innerHTML = '';
    }
  });
  </script>
</body>
</html>