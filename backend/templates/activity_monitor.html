<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Monitor | {{ activity.activity_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-blue-700 mb-2">Monitor Activity: {{ activity.activity_name }}</h1>
      <p class="text-lg text-gray-600">
        {{ activity.activity_type|title }} ‚Ä¢ {{ activity.participation_type|title }} ‚Ä¢ {{ activity.complexity|title }}
        {% if activity.module %}‚Ä¢ Module: {{ activity.module.title }}{% endif %}
      </p>
      <p class="text-xs text-gray-400 mt-1">
        Created {{ activity.created_at.strftime('%Y-%m-%d %H:%M') if activity.created_at else '' }}
        {% if activity.started_at %}| Started {{ activity.started_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
        {% if activity.ended_at %}| Ended {{ activity.ended_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
      </p>
      <div class="mt-4 flex gap-3">
        {% if activity.is_active %}
          <form hx-post="/ai/teacher/activities/{{ activity.id }}/end" hx-swap="outerHTML">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">End Activity</button>
          </form>
        {% else %}
          <form hx-post="/ai/teacher/activities/{{ activity.id }}/start" hx-swap="outerHTML">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Start Activity</button>
          </form>
        {% endif %}
        <a href="/ai/teacher/courses/{{ activity.course_id }}/inclass-activities"
           class="text-blue-600 hover:underline px-3 py-2 rounded">‚Üê Back to Activities</a>
      </div>
    </div>

    <!-- Participation List -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Student Participation</h2>

      {% if activity.participation_type == "group" %}
        <!-- Grouped table -->
        {% if groups %}
          {% for group in groups %}
            <div class="mb-6">
              <h3 class="font-bold text-blue-600 text-lg mb-2">Group: {{ group.group_name }}</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full table-auto text-left bg-blue-50 rounded">
                  <thead>
                    <tr>
                      <th class="px-4 py-2">Student</th>
                      <th class="px-4 py-2">Status</th>
                      <th class="px-4 py-2">Submitted At</th>
                      <th class="px-4 py-2">AI Feedback</th>
                      <th class="px-4 py-2">Peer Feedback</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in participations if p.group_id == group.id %}
                      <tr class="border-b last:border-b-0">
                        <td class="px-4 py-2">{{ p.student.f_name if p.student else 'Unknown' }}</td>
                        <td class="px-4 py-2">
                          {% if p.status == "submitted" %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                          {% else %}
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Not Submitted</span>
                          {% endif %}
                        </td>
                        <td class="px-4 py-2">
                          {{ p.submitted_at.strftime('%Y-%m-%d %H:%M') if p.submitted_at else '--' }}
                        </td>
                        <td class="px-4 py-2">
                          {% if p.ai_feedback %}
                            <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/ai-feedback"
                                    hx-target="#ai-feedback-modal"
                                    hx-trigger="click"
                                    class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                              View
                            </button>
                          {% else %}
                            <span class="text-gray-400 text-xs">Not Available</span>
                          {% endif %}
                        </td>
                        <td class="px-4 py-2">
                          {% if p.peer_feedback %}
                            <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/peer-feedback"
                                    hx-target="#ai-feedback-modal"
                                    hx-trigger="click"
                                    class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs hover:bg-purple-200">
                              View
                            </button>
                          {% else %}
                            <span class="text-gray-400 text-xs">Not Available</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-gray-500 py-6 text-center">No groups or participations yet.</p>
        {% endif %}
      {% else %}
        <!-- Flat (individual) table -->
        {% if participations %}
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto text-left bg-blue-50 rounded">
              <thead>
                <tr>
                  <th class="px-4 py-2">Student</th>
                  <th class="px-4 py-2">Status</th>
                  <th class="px-4 py-2">Submitted At</th>
                  <th class="px-4 py-2">AI Feedback</th>
                  <th class="px-4 py-2">Peer Feedback</th>
                </tr>
              </thead>
              <tbody>
                {% for p in participations %}
                  <tr class="border-b last:border-b-0">
                    <td class="px-4 py-2">{{ p.student.full_name if p.student else 'Unknown' }}</td>
                    <td class="px-4 py-2">
                      {% if p.status == "submitted" %}
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Submitted</span>
                      {% else %}
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">Not Submitted</span>
                      {% endif %}
                    </td>
                    <td class="px-4 py-2">
                      {{ p.submitted_at.strftime('%Y-%m-%d %H:%M') if p.submitted_at else '--' }}
                    </td>
                    <td class="px-4 py-2">
                      {% if p.ai_feedback %}
                        <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/ai-feedback"
                                hx-target="#ai-feedback-modal"
                                hx-trigger="click"
                                class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                          View
                        </button>
                      {% else %}
                        <span class="text-gray-400 text-xs">Not Available</span>
                      {% endif %}
                    </td>
                    <td class="px-4 py-2">
                      {% if p.peer_feedback %}
                        <button hx-get="/ai/teacher/activities/{{ activity.id }}/participation/{{ p.id }}/peer-feedback"
                                hx-target="#ai-feedback-modal"
                                hx-trigger="click"
                                class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs hover:bg-purple-200">
                          View
                        </button>
                      {% else %}
                        <span class="text-gray-400 text-xs">Not Available</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500 py-6 text-center">No participations yet.</p>
        {% endif %}
      {% endif %}
    </div>
                   <!-- Replace the activity-specific monitoring section in your activity_monitor.html -->

    <!-- Activity-Specific Monitoring Sections -->
    {% if activity.activity_type == 'peer_quiz' %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">üß© Peer Quiz Monitoring</h2>
        <div class="flex gap-2">
          <a href="/ai/teacher/activities/{{ activity.id }}/quiz-overview" 
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
            üìä Quiz Overview
          </a>
          <a href="/ai/teacher/activities/{{ activity.id }}/peer-analytics" 
             class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
            üìà Analytics
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-600">
            {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
          </div>
          <div class="text-sm text-blue-800">Quizzes Submitted</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-600" id="quiz-attempts-count">-</div>
          <div class="text-sm text-green-800">Total Quiz Attempts</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-600" id="comments-count">-</div>
          <div class="text-sm text-purple-800">Peer Comments</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-orange-600" id="avg-score">-</div>
          <div class="text-sm text-orange-800">Average Score</div>
        </div>
      </div>

      <!-- Recent Quiz Activity -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="font-semibold mb-3">üìù Recent Quiz Activity</h3>
        <div id="recent-activity" class="space-y-2">
          <p class="text-gray-500 text-sm">Loading recent activity...</p>
        </div>
        <div class="mt-4 text-center">
          <button hx-get="/ai/teacher/activities/{{ activity.id }}/quiz-activity" 
                  hx-target="#recent-activity"
                  hx-trigger="click"
                  class="text-blue-600 hover:underline text-sm">
            Load Recent Activity
          </button>
        </div>
      </div>
    </div>

    {% elif activity.activity_type == 'concept_mapping' %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">üó∫Ô∏è Concept Mapping Monitoring</h2>
        <div class="flex gap-2">
          <a href="/ai/teacher/activities/{{ activity.id }}/concept-map-overview" 
             class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
            üìä Map Overview
          </a>
          <a href="/ai/teacher/activities/{{ activity.id }}/concept-analytics" 
             class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
            üìà Analytics
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-purple-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-600">
            {{ participations|selectattr('status', 'equalto', 'submitted')|list|length }}
          </div>
          <div class="text-sm text-purple-800">Maps Submitted</div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-600" id="avg-concepts-count">
            {% set submitted_maps = participations|selectattr('status', 'equalto', 'submitted')|list %}
            {% if submitted_maps %}
              {% set total_concepts = 0 %}
              {% for p in submitted_maps %}
                {% if p.submission_data and p.submission_data.concepts %}
                  {% set total_concepts = total_concepts + p.submission_data.concepts|length %}
                {% endif %}
              {% endfor %}
              {{ "%.1f"|format(total_concepts / submitted_maps|length) if submitted_maps|length > 0 else 0 }}
            {% else %}
              0
            {% endif %}
          </div>
          <div class="text-sm text-blue-800">Avg Concepts</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-600" id="completion-rate">
            {% set total_participants = participations|length %}
            {% if total_participants > 0 %}
              {{ "%.0f"|format((submitted_maps|length / total_participants) * 100) }}%
            {% else %}
              0%
            {% endif %}
          </div>
          <div class="text-sm text-green-800">Completion Rate</div>
        </div>
        <div class="bg-orange-50 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-orange-600" id="complexity-score">
            {% if submitted_maps %}
              {% set avg_concepts = total_concepts / submitted_maps|length if submitted_maps|length > 0 else 0 %}
              {% if avg_concepts >= 12 %}High{% elif avg_concepts >= 8 %}Medium{% else %}Basic{% endif %}
            {% else %}
              -
            {% endif %}
          </div>
          <div class="text-sm text-orange-800">Avg Complexity</div>
        </div>
      </div>

      <!-- Recent Submissions -->
      <div class="bg-gray-50 rounded-lg p-4">
        <h3 class="font-semibold mb-3">üìù Recent Concept Map Activity</h3>
        <div id="recent-concept-activity" class="space-y-2">
          {% if submitted_maps %}
          {% for participation in submitted_maps|reverse %}
          <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 border-purple-400">
            <div class="flex items-start space-x-3">
              <span class="text-purple-600">üó∫Ô∏è</span>
              <div>
                <p class="text-sm">
                  <span class="font-medium">{{ participation.student.f_name }}</span>
                  {% if participation.group %}
                  <span class="text-gray-500">({{ participation.group.group_name }})</span>
                  {% endif %}
                  submitted their concept map
                </p>
                <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                  <span>{{ participation.submitted_at.strftime('%m/%d %H:%M') }}</span>
                  {% if participation.submission_data %}
                  <span>{{ participation.submission_data.concepts|length }} concepts</span>
                  <span>{{ participation.submission_data.connections|length }} chars</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="flex-shrink-0">
              <a href="/ai/teacher/activities/{{ activity.id }}/concept-map/{{ participation.id }}/view" 
                 class="text-purple-600 hover:text-purple-800 text-xs">
                View ‚Üí
              </a>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p class="text-gray-500 text-sm">No concept maps submitted yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Modal Target for Feedback -->
  <div id="ai-feedback-modal"></div>
  <script>
  // Optional: Dismiss modal on click outside or ESC
  document.addEventListener('click', function(e) {
    const modal = document.getElementById('ai-feedback-modal');
    if (modal && modal.innerHTML.trim() !== '' && !modal.contains(e.target)) {
      modal.innerHTML = '';
    }
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
      document.getElementById('ai-feedback-modal').innerHTML = '';
    }
  });
</script>
</body>
</html>